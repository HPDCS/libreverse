/*
x86 Length Disassembler test.
Copyright (C) 2016 Alessandro Pellegrini
Copyright (C) 2013 Byron Platt

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

#include <stdio.h>
#include <string.h>

#include "ld.h"

/* This is some test code, taken from a disassembly of the Linux Kernel scheduler
 * plus other x64 instructions and three-byte opcodes, for the purpose of testing */
unsigned char byte_64[] = {0x48,0x89,0x04,0x48, /* mov %rax,(%rax,%rcx,2) */
			   0x48,0xb8,0xaa,0x0a,0x00,0x00,0x00,0x00,0x00,0x00, /* movabs $0xaaa,%rax */
			   0x66,0x0f,0x38,0x08,0xc8, /* psignb %xmm0,%xmm1 */
			   /* Linux 4.1 x64 finish_task_switch() from here on */
			   0x66,0x0f,0x1f,0x44,0x00,0x00, /* nopw 0x0(%rax,%rax,1) */
			   0x55, /* push %rbp */
			   0x48,0x89,0xe5, /* mov %rsp,%rbp */
			   0x41,0x56, /* push %r14 */
			   0x41,0x55, /* push %r13 */
			   0x41,0x54, /* push %r12 */
			   0x49,0x89,0xfc, /* mov %rdi,%r12 */
			   0x53, /* push %rbx */
			   0x48,0xc7,0xc3,0xc0,0x5d,0x01,0x00, /* mov $0x15dc0,%rbx */
			   0x65,0x48,0x03,0x1d,0xa6,0xb9,0xf7,0x7e, /* add %gs:0x7ef7b9a6(%rip),%rbx */
			   0x4c,0x8b,0xab,0x30,0x09,0x00,0x00, /* mov 0x930(%rbx),%r13*/
			   0x48,0xc7,0x83,0x30,0x09,0x00,0x00,0x00,0x00,0x00,0x00, /* movq $0x0,0x930(%rbx) */
			   0x4c,0x8b,0x37, /* mov (%rdi),%r14 */
			   0x65,
                           0x48,0x8b,0x34,0x25,0xc0,0xb8,0x00,0x00,0x0f,0x1f,0x44,0x00,0x00,0x41,
                           0xc7,0x44,0x24,0x28,0x00,0x00,0x00,0x00,0xe9,0x2d,0x00,0x00,0x00,0x66,
                           0x83,0x03,0x02,0xfb,0x66,0x0f,0x1f,0x44,0x00,0x00,0x4d,0x85,0xed,0x74,
                           0x07,0xf0,0x41,0xff,0x4d,0x4c,0x74,0x46,0x49,0x83,0xfe,0x40,0x74,0x4a,
                           0x48,0x89,0xd8,0x5b,0x41,0x5c,0x41,0x5d,0x41,0x5e,0x5d,0xc3,0x0f,0x1f,
                           0x40,0x00,0xb8,0x02,0x00,0x00,0x00,0xf0,0x66,0x0f,0xc1,0x03,0xa8,0x01,
                           0x74,0xc9,0x83,0xe0,0xfe,0x48,0x89,0xdf,0x8d,0x70,0x02,0x0f,0xb7,0xf6,
                           0xe8,0xa1,0x27,0xf8,0xff,0x66,0x90,0xeb,0xb4,0x0f,0x1f,0x44,0x00,0x00,
                           0xe8,0xb3,0xf7,0x0b,0x00,0xeb,0x96,0x90,0x4c,0x89,0xef,0xe8,0x18,0x82,
                           0xfd,0xff,0xeb,0xb0,0x49,0x8b,0x44,0x24,0x60,0x48,0x8b,0x80,0x98,0x00,
                           0x00,0x00,0x48,0x85,0xc0,0x74,0x05,0x4c,0x89,0xe7,0xff,0xd0,0x4c,0x89,
                           0xe7,0xe8,0x78,0x7e,0x07,0x00,0xf0,0x41,0xff,0x4c,0x24,0x10,0x74,0x02,
                           0xeb,0x8e,0x4c,0x89,0xe7,0xe8,0x36,0x87,0xfd,0xff,0xeb,0x84,0x0f,0x1f,
                           0x40,0x00};

unsigned char byte_32[] = {0x55, /* push %ebp */
                           0x31,0xD2, /* xor %edx, %edx */
                           0x89,0xE5, /* mov %esp, %ebp */
                           0x8B,0x45,0x08, /* mov 0x8(%ebp), %eax */
                           0x56, /* push %esi */
                           0x8B,0x75,0x0C, /* mov 0xc(%ebp), %esi */
                           0x53, /* push %ebx */
                           0x8D,0x58,0xFF, /* lea -1(%eax), %ebx */
                           0x0F,0xB6,0x0C,0x16, /* movzx (%esi, %edx, 1), %ecx */
                           0x88,0x4C,0x13,0x01, /* mov %cl, 0x1(%ebx, %edx, 1) */
                           0x42, /* inc %edx <--- This is a REX prefix if interpreted in x64 mode */
                           0x84,0xC9, /* test %cl, %cl */
                           0x75,0xF1, /* jnz -14 */
                           0x5B, /* pop %ebx */
                           0x5E, /* pop esi */
                           0x5D, /* pop %ebp */
                           0xC3 /* ret */};

int main(void) {
    int i, j;
    unsigned char *opcode;
    unsigned int length;

    printf("*** Lenght disassemblying of x64 code ***\n");
    opcode = byte_64;
    for (i=0; i < sizeof(byte_64); i += length) {
        length = length_disasm(opcode, MODE_X64);
		printf("%03d: ", i);
		for(j = 0; j < length; j++)
			printf("%02x ", *opcode++);
		printf("\n");
    }

    printf("\n*** Lenght disassemblying of x32 code ***\n");
    opcode = byte_32;
    for (i=0; i < sizeof(byte_32); i += length) {
        length = length_disasm(opcode, MODE_X32);
		printf("%03d: ", i);
		for(j = 0; j < length; j++)
			printf("%02x ", *opcode++);
		printf("\n");
    }

    return 0;
}
